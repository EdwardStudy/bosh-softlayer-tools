#!/bin/bash

(
  set -e
  
  echo -e "\n Manually set kernel directory and install kernel module..."
  # export KERN_DIR=/lib/modules/3.13.0-53-generic
  # export KERN_DIR=/usr/src/linux-headers-3.16.0-4-amd64
  /etc/init.d/vboxdrv setup

  echo -e "\n Get stemcell version..."
  s3cmd get s3://bosh-softlayer-cpi-stemcells/stemcell-version stemcell-version --access_key=$S3_ACCESS_KEY --secret_key=$S3_SECRET_KEY
  STEMCELL_VERSION=`cat stemcell-version`

  echo -e "\n Get stemcell..."
  s3cmd get s3://bosh-softlayer-cpi-stemcells/bosh-stemcell-${STEMCELL_VERSION}-vsphere-esxi-ubuntu-trusty-go_agent.tgz bosh-stemcell-${STEMCELL_VERSION}-vsphere-esxi-ubuntu-trusty-go_agent.tgz --access_key=$S3_ACCESS_KEY --secret_key=$S3_SECRET_KEY

  echo -e "\n Unpacking tgz..."
  tar zxf bosh-stemcell-${STEMCELL_VERSION}-vsphere-*.tgz
  tar zxf image

  # echo -e "\n Getting stemcell version..."
  # grep "version:" stemcell.MF | head -n1 | sed 's/[^0-9]//g' > stemcell-version

  echo -e "\n Converting vmdk to vhd..."
  VBoxManage clonehd *.vmdk --format VHD bosh-stemcell-${STEMCELL_VERSION}-softlayer.vhd

  echo -e "\n Placing object in Softlayer..."
  swift -A https://${SWIFT_CLUSTER}.objectstorage.softlayer.net/auth/v1.0/ -U $SWIFT_USERNAME -K $SWIFT_API_KEY upload stemcells bosh-stemcell-${STEMCELL_VERSION}-softlayer.vhd
)